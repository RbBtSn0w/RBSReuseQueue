name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  spm:
    name: SPM Build & Test
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: swift build
      - name: Test
        run: swift test

  tuist:
    name: Tuist Build & Test
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install --formula tuist
      - name: Generate Project
        run: tuist generate
      - name: Test Framework
        run: xcodebuild test -workspace RBSReuseQueue.xcworkspace -scheme RBSReuseQueue -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' clean test
      - name: Build Example App
        run: xcodebuild build -workspace RBSReuseQueue.xcworkspace -scheme RBSReuseQueueExample -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' clean build

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [spm, tuist]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install Dependencies
        run: npm install
      - name: Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release
